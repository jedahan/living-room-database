{"version":3,"file":"RoomDB.min.js","sources":["../src/parse.js","../src/AbstractClient.js","../src/terms.js","../src/LocalClient.js","../src/Fact.js","../src/RoomDB.js"],"sourcesContent":["'use strict';\n\nconst ohm = require('ohm-js')\n\nconst grammar = ohm.grammar(`\n  G {\n\n    factOrPattern\n      = term*\n\n    term\n      = id\n      | word\n      | value\n      | variable\n      | wildcard\n      | hole\n\n    id\n      = \"#\" alnum*\n\n    value\n      = keyword<\"true\">   -- true\n      | keyword<\"false\">  -- false\n      | keyword<\"null\">   -- null\n      | number\n      | string\n\n    variable\n      = \"$\" alnum+\n\n    wildcard\n      = \"$\"\n\n    hole\n      = \"_\"\n\n    word\n      = (~special any)+  -- nonspace\n      | space+           -- space\n\n    keyword<k>\n      = k ~alnum\n\n    number\n      = float (\"e\" float)?\n\n    float\n      = integer (\".\" digit+)?\n\n    integer\n      = (\"+\" | \"-\")? digit+\n\n    string\n      = \"\\\\\"\" (~\"\\\\\"\" ~\"\\\\n\" any)* \"\\\\\"\"\n\n    special\n      = id | value | variable | wildcard | hole | space\n\n  }\n`);\n\nconst semantics = grammar.createSemantics().addOperation('parse', {\n  factOrPattern(terms) {\n    return terms.parse();\n  },\n  id(_, cs) {\n    return {id: cs.sourceString};\n  },\n  value_true(_) {\n    return {value: true};\n  },\n  value_false(_) {\n    return {value: false};\n  },\n  value_null(_) {\n    return {value: null};\n  },\n  variable(_, cs) {\n    return {variable: cs.sourceString};\n  },\n  wildcard(_) {\n    return {wildcard: true};\n  },\n  hole(_) {\n    return {hole: true};\n  },\n  word_nonspace(_) {\n    return {word: this.sourceString};\n  },\n  word_space(_) {\n    return {word: ' '};\n  },\n  number(_1, _2, _3) {\n    return {value: parseFloat(this.sourceString)};\n  },\n  string(_oq, cs, _cq) {\n    const chars = [];\n    let idx = 0;\n    cs = cs.parse();\n    while (idx < cs.length) {\n      let c = cs[idx++];\n      if (c === '\\\\' && idx < cs.length) {\n        c = cs[idx++];\n        switch (c) {\n          case 'n': c = '\\n'; break;\n          case 't': c = '\\t'; break;\n          default: idx--;\n        }\n      }\n      chars.push(c);\n    }\n    return {value: chars.join('')};\n  },\n  _terminal() {\n    return this.sourceString;\n  }\n});\n\nexport default function parse(str, optRule) {\n  const rule = optRule || 'factOrPattern';\n  const matchResult = grammar.match(str.trim(), rule);\n  if (matchResult.succeeded()) {\n    return semantics(matchResult).parse();\n  } else {\n    throw new Error(`invalid ${rule}: ${str}`);\n  }\n};\n","'use strict';\n\nimport parse from './parse'\n\nconst MAX_PARSE_CACHE_SIZE = 1000;\n\nexport default class AbstractClient {\n  constructor(id) {\n    this._id = id;\n    this._parseCache = new Map();\n    this._asserts = [];\n    this._retracts = [];\n  }\n\n  assert(factString, ...fillerValues) {\n    const fact = this._toJSONFactOrPattern(factString, ...fillerValues);\n    this._asserts.push(fact);\n  }\n\n  retract(patternString, ...fillerValues) {\n    const pattern = this._toJSONFactOrPattern(patternString, ...fillerValues);\n    this._retracts.push(pattern);\n  }\n\n  async flushChanges() {\n    throw new Error('subclass responsibility');\n  }\n\n  async immediatelyAssert(factString, ...fillerValues) {\n    this.assert(factString, ...fillerValues);\n    await this.flushChanges();\n  }\n\n  async immediatelyRetract(patternString, ...fillerValues) {\n    this.retract(patternString, ...fillerValues);\n    await this.flushChanges();\n  }\n\n  async immediatelyRetractEverythingAbout(name) {\n    throw new Error('subclass responsibility');\n  }\n\n  async immediatelyRetractEverythingAssertedByMe() {\n    throw new Error('subclass responsibility');\n  }\n\n  async getAllFacts() {\n    throw new Error('subclass responsibility');\n  }\n\n  _toJSONFactOrPattern(factOrPatternString, ...fillerValues) {\n    if (arguments.length === 0) {\n      throw new Error('not enough arguments!');\n    }\n    if (typeof factOrPatternString !== 'string') {\n      throw new Error('factOrPatternString must be a string!');\n    }\n    let terms = this._parse(factOrPatternString);\n    if (fillerValues.length > 0) {\n      terms = terms.slice();\n    }\n    for (let idx = 0; idx < terms.length; idx++) {\n      const term = terms[idx];\n      if (term.hasOwnProperty('hole')) {\n        if (fillerValues.length === 0) {\n          throw new Error('not enough filler values!');\n        }\n        terms[idx] = this._toJSONTerm(fillerValues.shift());\n      }\n    }\n    if (fillerValues.length > 0) {\n      throw new Error('too many filler values!');\n    }\n    return terms;\n  }\n\n  _toJSONTerm(value) {\n    return {value: value};\n  }\n\n  _parse(factOrPatternString) {\n    if (this._parseCache.has(factOrPatternString)) {\n      return this._parseCache.get(factOrPatternString);\n    } else {\n      this._clearParseCacheIfTooBig();\n      const terms = parse(factOrPatternString);\n      this._parseCache.set(factOrPatternString, terms);\n      return terms;\n    }\n  }\n\n  _clearParseCacheIfTooBig() {\n    if (this._parseCache.size > MAX_PARSE_CACHE_SIZE) {\n      this.clearParseCache();\n    }\n  }\n\n  clearParseCache() {\n    this._parseCache.clear();\n  }\n}\n","'use strict';\n\nclass Term {\n  toString() {\n    throw new Error('subclass responsibility');\n  }\n\n  toJSON() {\n    throw new Error('subclass responsibility');\n  }\n\n  toRawValue() {\n    throw new Error('subclass responsibility');\n  }\n\n  match(that, env) {\n    throw new Error('subclass responsibility');\n  }\n}\n\nTerm.fromJSON = json => {\n  if (json.hasOwnProperty('id')) {\n    return new Id(json.id);\n  } else if (json.hasOwnProperty('word')) {\n    return new Word(json.word);\n  } else if (json.hasOwnProperty('value')) {\n    return new Value(json.value);\n  } else if (json.hasOwnProperty('blobRef')) {\n    return new BlobRef(json.blobRef);\n  } else if (json.hasOwnProperty('variable')) {\n    return new Variable(json.variable);\n  } else if (json.hasOwnProperty('wildcard')) {\n    return new Wildcard();\n  } else if (json.hasOwnProperty('hole')) {\n    return new Hole();\n  } else {\n    throw new Error('unrecognized JSON term: ' + JSON.stringify(json));\n  }\n};\n\nclass Id extends Term {\n  constructor(name) {\n    super();\n    this.name = name;\n  }\n\n  toString() {\n    return '#' + this.name;\n  }\n\n  toJSON() {\n    return {id: this.name};\n  }\n\n  toRawValue() {\n    return this;\n  }\n\n  match(that, env) {\n    return that instanceof Id && this.name === that.name ?\n        env :\n        null;\n  }\n}\n\nclass Word extends Term {\n  constructor(value) {\n    super();\n    this.value = value;\n  }\n\n  toString() {\n    return this.value;\n  }\n\n  toJSON() {\n    return {word: this.value};\n  }\n\n  toRawValue() {\n    return this;\n  }\n\n  match(that, env) {\n    return that instanceof Word && this.value === that.value ?\n        env :\n        null;\n  }\n}\n\nclass Value extends Term {\n  constructor(value) {\n    super();\n    this.value = value;\n  }\n\n  toString() {\n    return JSON.stringify(this.value);\n  }\n\n  toJSON() {\n    return {value: this.value};\n  }\n\n  toRawValue() {\n    return this.value;\n  }\n\n  match(that, env) {\n    return that instanceof Value && this.value === that.value ?\n        env :\n        null;\n  }\n}\n\nclass BlobRef extends Term {\n  constructor(id) {\n    super();\n    this.id = id;\n  }\n\n  toString() {\n    return '@' + this.id;\n  }\n\n  toJSON() {\n    return {blobRef: this.id};\n  }\n\n  toRawValue() {\n    return this;\n  }\n\n  match(that, env) {\n    return that instanceof BlobRef && this.id === that.id ?\n        env :\n        null;\n  }\n}\n\nclass Variable extends Term {\n  constructor(name) {\n    super();\n    this.name = name;\n  }\n\n  toString() {\n    return '$' + this.name;\n  }\n\n  toJSON() {\n    return {variable: this.name};\n  }\n\n  toRawValue() {\n    throw new Error('Variable\\'s toRawValue() should never be called!');\n  }\n\n  match(that, env) {\n    if (env[this.name] === undefined) {\n      env[this.name] = that;\n      return env;\n    } else {\n      return env[this.name].match(that, env);\n    }\n  }\n}\n\nclass Wildcard extends Term {\n  constructor() {\n    super();\n    // no-op\n  }\n\n  toString() {\n    return '$';\n  }\n\n  toJSON() {\n    return {wildcard: true};\n  }\n\n  toRawValue() {\n    throw new Error('Wildcard\\'s toRawValue() should never be called!');\n  }\n\n  match(that, env) {\n    return env;\n  }\n}\n\nclass Hole extends Term {\n  constructor() {\n    super();\n    // no-op\n  }\n\n  toString() {\n    return '_';\n  }\n\n  toJSON() {\n    return {hole: true};\n  }\n\n  toRawValue() {\n    throw new Error('Hole\\'s toRawValue() should never be called!');\n  }\n\n  match(that, env) {\n    throw new Error('Hole\\'s match() should never be called!');\n  }\n}\n\nexport {\n  Term,\n  Id,\n  Word,\n  Value,\n  BlobRef,\n  Variable,\n  Wildcard,\n  Hole\n}\n","'use strict';\n\nimport AbstractClient from './AbstractClient'\nimport {Term} from './terms'\n\nexport default class LocalClient extends AbstractClient {\n  constructor(db, id) {\n    super(id);\n    this._db = db;\n  }\n\n  select(...patternStrings) {\n    const patterns = patternStrings.map(p =>\n      p instanceof Array ?\n          this._toJSONFactOrPattern(...p) :\n          this._toJSONFactOrPattern(p));\n    const solutions = this._db.select(...patterns);\n    const results = {\n      async doAll(callbackFn) {\n        await callbackFn(solutions);\n        return results;\n      },\n      async do(callbackFn) {\n        for (let solution of solutions) {\n          for (let name in solution) {\n            // force serialization and deserialization to simulate going over the network\n            const json = JSON.parse(JSON.stringify(solution[name]));\n            solution[name] = Term.fromJSON(json).toRawValue();\n          }\n          await callbackFn(solution);\n        }\n        return results;\n      },\n      async count() {\n        return solutions.length;\n      },\n      async isEmpty() {\n        return solutions.length === 0;\n      },\n      async isNotEmpty() {\n        return solutions.length > 0;\n      }\n    };\n    return results;\n  }\n\n  async flushChanges() {\n    this._retracts.forEach(pattern => this._db.retract(this._id, pattern));\n    this._retracts = [];\n    this._asserts.forEach(fact => this._db.assert(this._id, fact));\n    this._asserts = [];\n  }\n\n  async immediatelyRetractEverythingAbout(name) {\n    return this._db.retractEverythingAbout(this._id, name);\n  }\n\n  async immediatelyRetractEverythingAssertedByMe() {\n    return this._db.retractEverythingAssertedBy(this._id);\n  }\n\n  async getAllFacts() {\n    return this._db.getAllFacts();\n  }\n\n  toString() {\n    return `[LocalClient ${this._id}]`;\n  }\n}\n\nmodule.exports = LocalClient;\n","'use strict';\n\nimport {Term, Variable, Wildcard} from './terms'\n\nclass Fact {\n  constructor(terms) {\n    this.terms = terms;\n  }\n\n  hasVariablesOrWildcards() {\n    return this.terms.some(term =>\n        term instanceof Variable ||\n        term instanceof Wildcard);\n  }\n\n  match(that, env) {\n    if (this.terms.length !== that.terms.length) {\n      return null;\n    }\n    for (let idx = 0; idx < this.terms.length; idx++) {\n      const thisTerm = this.terms[idx];\n      const thatTerm = that.terms[idx];\n      if (!thisTerm.match(thatTerm, env)) {\n        return null;\n      }\n    }\n    return env;\n  }\n\n  toString() {\n    return this.terms.map(term => term.toString()).join('');\n  }\n}\n\nFact.fromJSON =\n    jsonTerms => new Fact(jsonTerms.map(jsonTerm => Term.fromJSON(jsonTerm)));\n\nexport default Fact\n","'use strict';\n\nimport LocalClient from './LocalClient'\nimport {Id} from './terms'\nimport Fact from './Fact'\n\nfunction flatten(obj) {\n  for (let prop in obj) {\n    obj[prop] = obj[prop];\n  }\n  return obj;\n}\n\nexport default class RoomDB {\n  constructor() {\n    this._factMap = new Map();\n  }\n\n  select(...jsonPatterns) {\n    const patterns = jsonPatterns.map(jsonPattern => Fact.fromJSON(jsonPattern));\n    const solutions = [];\n    this._collectSolutions(patterns, Object.create(null), solutions);\n    return solutions.map(flatten);\n  }\n\n  _collectSolutions(patterns, env, solutions) {\n    if (patterns.length === 0) {\n      solutions.push(env);\n    } else {\n      const pattern = patterns[0];\n      for (let fact of this._facts) {\n        const newEnv = Object.create(env);\n        if (pattern.match(fact, newEnv)) {\n          this._collectSolutions(patterns.slice(1), newEnv, solutions);\n        }\n      }\n    }\n  }\n\n  assert(clientId, factJSON) {\n    const fact = Fact.fromJSON(factJSON);\n    if (fact.hasVariablesOrWildcards()) {\n      throw new Error('cannot assert a fact that has variables or wildcards!');\n    }\n    fact.asserter = clientId;\n    this._factMap.set(fact.toString(), fact);\n  }\n\n  retract(clientId, factJSON) {\n    const pattern = Fact.fromJSON(factJSON);\n    if (pattern.hasVariablesOrWildcards()) {\n      const factsToRetract =\n          this._facts.filter(fact => pattern.match(fact, Object.create(null)));\n      factsToRetract.forEach(fact => this._factMap.delete(fact.toString()));\n      return factsToRetract.length;\n    } else {\n      return this._factMap.delete(pattern.toString()) ? 1 : 0;\n    }\n  }\n\n  retractEverythingAbout(clientId, name) {\n    const id = new Id(name);\n    const emptyEnv = Object.create(null);\n    const factsToRetract =\n        this._facts.filter(fact => fact.terms.some(term => id.match(term, emptyEnv)));\n    factsToRetract.forEach(fact => this._factMap.delete(fact.toString()));\n    return factsToRetract.length;\n  }\n\n  retractEverythingAssertedBy(clientId) {\n    const factsToRetract = this._facts.filter(fact => fact.asserter === clientId);\n    factsToRetract.forEach(fact => this._factMap.delete(fact.toString()));\n    return factsToRetract.length;\n  }\n\n  get _facts() {\n    return Array.from(this._factMap.values());\n  }\n\n  getAllFacts() {\n    return this._facts.map(fact => fact.toString());\n  }\n\n  toString() {\n    return this._facts.map(fact => '<' + fact.asserter + '> ' + fact.toString()).join('\\n');\n  }\n\n  client(id = 'local-client') {\n    return new LocalClient(this, id);\n  }\n}\n"],"names":["grammar","require","semantics","createSemantics","addOperation","factOrPattern","terms","parse","id","_","cs","sourceString","value_true","value","value_false","value_null","variable","wildcard","hole","[object Object]","word","this","word_space","_1","_2","_3","parseFloat","_oq","_cq","chars","idx","length","c","push","join","MAX_PARSE_CACHE_SIZE","AbstractClient","_id","_parseCache","Map","_asserts","_retracts","factString","fillerValues","fact","_toJSONFactOrPattern","patternString","pattern","Error","assert","flushChanges","retract","name","factOrPatternString","arguments","_parse","slice","hasOwnProperty","_toJSONTerm","shift","has","get","_clearParseCacheIfTooBig","str","optRule","rule","matchResult","match","trim","succeeded","set","size","clearParseCache","clear","Term","that","env","fromJSON","json","Id","Word","Value","BlobRef","blobRef","Variable","Wildcard","super","JSON","stringify","undefined","LocalClient","db","_db","patternStrings","patterns","map","p","Array","solutions","select","results","doAll","callbackFn","solution","toRawValue","count","isEmpty","isNotEmpty","forEach","retractEverythingAbout","retractEverythingAssertedBy","getAllFacts","module","exports","Fact","some","term","thisTerm","thatTerm","toString","flatten","obj","prop","jsonTerms","jsonTerm","_factMap","jsonPatterns","jsonPattern","_collectSolutions","Object","create","_facts","newEnv","clientId","factJSON","hasVariablesOrWildcards","asserter","factsToRetract","filter","delete","emptyEnv","from","values"],"mappings":"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"}